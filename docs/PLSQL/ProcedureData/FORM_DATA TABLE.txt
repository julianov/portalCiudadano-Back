CREATE SEQUENCE "CIUDADANOS"."FORMS_DATA_ID_SEQ" 
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

CREATE TABLE "CIUDADANOS"."FORMS_DATA" 
(
    "ID" NUMBER(19,0) NOT NULL ENABLE, 
    "FORM_UNIT" VARCHAR2(255) NOT NULL ENABLE, 
    "PROCEDURE_DATA_ID" NUMBER(19,0) NOT NULL ENABLE, 
    "USER_ID" NUMBER(19,0) NOT NULL ENABLE, 
    "ELEMENTS" CLOB NOT NULL ENABLE,
    "ATTACHMENTS" CLOB, 
	"MULTIMEDIA_ID" VARCHAR2(1024 BYTE), 
    "STATUS" VARCHAR2(255 BYTE) DEFAULT 'PENDIENTE' NOT NULL ENABLE, 
    "APPROVED_AT" DATE, 
    "CREATED_AT" TIMESTAMP (6), 
    "UPDATED_AT" TIMESTAMP (6), 
    CHECK (status in ('PENDIENTE', 'APROBADO', 'CANCELADO')) ENABLE, 
    CONSTRAINT "FORMS_DATA_ID_PK" PRIMARY KEY ("ID")
    USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
    STORAGE( INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
    PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
    BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
    TABLESPACE "APPSDATA"  ENABLE, 
    CONSTRAINT "FK_FORMS_DATA_USERS" FOREIGN KEY ("USER_ID")
    REFERENCES "CIUDADANOS"."USERS" ("ID") ON DELETE CASCADE ENABLE

) SEGMENT CREATION DEFERRED 
PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
NOCOMPRESS LOGGING
STORAGE( INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
TABLESPACE "APPSDATA" ;

-- Agregar la clave foránea
ALTER TABLE CIUDADANOS.FORMS_DATA
ADD CONSTRAINT FK_PROCEDURE_DATA
FOREIGN KEY (PROCEDURE_DATA_ID)
REFERENCES CIUDADANOS.PROCEDURE_DATA(ID)
ON DELETE CASCADE;

-- Agregar la restricción de unicidad
ALTER TABLE CIUDADANOS.FORMS_DATA
ADD CONSTRAINT UQ_FORM_UNIT_USER_PROCEDURE
UNIQUE (FORM_UNIT, USER_ID, PROCEDURE_DATA_ID);

CREATE OR REPLACE TRIGGER "CIUDADANOS"."FORMS_DATA_ID_TRG" 
BEFORE INSERT ON FORMS_DATA
FOR EACH ROW
BEGIN
    IF :new.ID IS NULL THEN
        SELECT forms_data_id_seq.nextval INTO :new.ID FROM dual;
    END IF;
END;
/
ALTER TRIGGER "CIUDADANOS"."FORMS_DATA_ID_TRG" ENABLE;

CREATE OR REPLACE TRIGGER "CIUDADANOS"."FORMS_DATA_CREATED_AT_TRG" 
BEFORE INSERT ON FORMS_DATA
FOR EACH ROW
BEGIN
    IF :new.CREATED_AT IS NULL THEN
        :new.CREATED_AT := SYSTIMESTAMP;
    END IF;
END;
/
ALTER TRIGGER "CIUDADANOS"."FORMS_DATA_CREATED_AT_TRG" ENABLE;

CREATE OR REPLACE TRIGGER "CIUDADANOS"."FORMS_DATA_UPDATED_AT_TRG" 
BEFORE UPDATE ON FORMS_DATA
FOR EACH ROW
BEGIN
    :new.UPDATED_AT := SYSTIMESTAMP;
END;
/
ALTER TRIGGER "CIUDADANOS"."FORMS_DATA_UPDATED_AT_TRG" ENABLE;
